<div class="leave-type-container">
  <!-- Dashboard Metrics Cards -->
  <div class="dashboard-metrics">
    <div class="metric-card total-leaves">
      <div class="metric-label">Total Leaves</div>
      <div class="metric-value">{{ totalLeaves }}</div>
    </div>
    <div class="metric-card pending-leaves">
      <div class="metric-label">Pending</div>
      <div class="metric-value">{{ pendingLeaves }}</div>
    </div>
    <div class="metric-card approved-leaves">
      <div class="metric-label">Approved</div>
      <div class="metric-value">{{ approvedLeaves }}</div>
    </div>
    <div class="metric-card cancelled-leaves">
      <div class="metric-label">Cancelled</div>
      <div class="metric-value">{{ cancelledLeaves }}</div>
    </div>
    <div class="metric-card most-used-type">
      <div class="metric-label">Most Used Type</div>
      <div class="metric-value">{{ mostUsedType }}</div>
    </div>
  </div>
  <div class="page-header">
    <div class="header-content">
      <h1>Apply for Leave</h1>
      <p class="subtitle">Apply for a leave, view your leave history, and manage your leave requests.</p>
    </div>
    <button class="btn btn-primary add-button" (click)="onApplyLeave()">
      <span class="material-symbols-outlined">add</span>
      <span>Apply for Leave</span>
    </button>
  </div>

  <div class="table-container">
    <div class="table-wrapper">
      <table class="leave-types-table">
        <thead>
          <tr>
            <th class="col-leave-type">Leave Type</th>
            <th class="col-description">Reason</th>
            <th class="col-accrual">Start Date</th>
            <th class="col-usage">End Date</th>
            <th class="col-expiration">Total Days</th>
            <th class="col-documents">Document</th>
            <th class="col-eligibility">Status</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let leave of leaves" class="table-row">
            <td class="col-leave-type font-medium">{{ leave.type }}</td>
            <td class="col-description">{{ leave.reason }}</td>
            <td class="col-accrual">{{ leave.startDate }}</td>
            <td class="col-usage">{{ leave.endDate }}</td>
            <td class="col-expiration">{{ leave.totalDays }}</td>
            <td class="col-documents">{{ leave.documentName }}</td>
            <td class="col-eligibility">{{ leave.status }}</td>
            <td class="col-actions">
              <div class="action-buttons">
                <button class="btn-icon view-btn" (click)="onViewLeave(leave)" title="View">
                  <span class="material-symbols-outlined">visibility</span>
                </button>
                <button class="btn-icon delete-btn" (click)="onCancelLeave(leave)" title="Cancel" [disabled]="leave.status !== 'Pending'">
                  <span class="material-symbols-outlined">cancel</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal for leave application form -->
  <div *ngIf="showApplyForm" class="modal-backdrop">
    <div class="modal">
      <h2>Apply for Leave</h2>
      <form (ngSubmit)="submitLeaveApplication()" #leaveForm="ngForm" enctype="multipart/form-data" novalidate>
        <div class="form-row">
          <div class="form-col">
            <div class="form-group" [class.invalid]="formSubmitted && validationErrors.leaveType">
              <label for="leaveType">Leave Type</label>
              <select id="leaveType" name="leaveType" [(ngModel)]="form.leaveType" required>
                <option value="" disabled selected>Select leave type</option>
                <option *ngFor="let type of leaveTypes" [value]="type">{{ type }}</option>
              </select>
              <div class="error-message" *ngIf="formSubmitted && validationErrors.leaveType">{{ validationErrors.leaveType }}</div>
            </div>
            <div class="form-group" [class.invalid]="formSubmitted && validationErrors.startDate">
              <label for="startDate">Start Date</label>
              <input id="startDate" name="startDate" type="date" [(ngModel)]="form.startDate" required (change)="updateTotalDays()" />
              <div class="error-message" *ngIf="formSubmitted && validationErrors.startDate">{{ validationErrors.startDate }}</div>
            </div>
            <div class="form-group" [class.invalid]="formSubmitted && validationErrors.endDate">
              <label for="endDate">End Date</label>
              <input id="endDate" name="endDate" type="date" [(ngModel)]="form.endDate" required (change)="updateTotalDays()" />
              <div class="error-message" *ngIf="formSubmitted && validationErrors.endDate">{{ validationErrors.endDate }}</div>
            </div>
            <div class="form-group">
              <label>Total Days</label>
              <input type="number" [value]="form.totalDays" readonly />
            </div>
          </div>
          <div class="form-col">
            <div class="form-group" [class.invalid]="formSubmitted && validationErrors.reason">
              <label for="reason">Reason</label>
              <textarea id="reason" name="reason" [(ngModel)]="form.reason" rows="3" required></textarea>
              <div class="error-message" *ngIf="formSubmitted && validationErrors.reason">{{ validationErrors.reason }}</div>
            </div>
            <div class="form-group">
              <label for="document">Supporting Document <span style="color:#888;font-weight:400;">(optional)</span></label>
              <input id="document" name="document" type="file" (change)="onFileChange($event)" />
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" (click)="showApplyForm = false">Cancel</button>
          <button type="submit">Submit Application</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading/Progress Modal -->
  <div *ngIf="isSubmitting" class="modal-backdrop">
    <div class="progress-modal">
      <div class="progress-spinner"></div>
      <div class="progress-message">Submitting your application...</div>
    </div>
  </div>

  <!-- Success Modal -->
  <div *ngIf="showSuccessModal" class="modal-backdrop">
    <div class="success-modal">
      <span class="material-symbols-outlined success-icon">check_circle</span>
      <div class="success-message">Submitted successfully!</div>
    </div>
  </div>

  <!-- Modal for viewing leave details -->
  <div *ngIf="showViewModal" class="modal-backdrop">
    <div class="details-modal improved-details-modal">
      <h2>Leave Details</h2>
      <table class="details-table improved-details-table">
        <tr><th>Leave Type</th><td>{{ selectedLeave?.type }}</td></tr>
        <tr><th>Reason</th><td>{{ selectedLeave?.reason }}</td></tr>
        <tr><th>Start Date</th><td>{{ selectedLeave?.startDate }}</td></tr>
        <tr><th>End Date</th><td>{{ selectedLeave?.endDate }}</td></tr>
        <tr><th>Total Days</th><td>{{ selectedLeave?.totalDays }}</td></tr>
        <tr><th>Status</th><td><span class="status-badge" [ngClass]="selectedLeave?.status?.toLowerCase()">{{ selectedLeave?.status }}</span></td></tr>
        <tr>
          <th>Document</th>
          <td>
            <ng-container *ngIf="selectedLeave?.documentName; else noDoc">
              <span class="file-type-icon">
                <ng-container [ngSwitch]="getFileType(selectedLeave?.documentName)">
                  <span *ngSwitchCase="'image'" class="material-symbols-outlined">image</span>
                  <span *ngSwitchCase="'pdf'" class="material-symbols-outlined">picture_as_pdf</span>
                  <span *ngSwitchCase="'doc'" class="material-symbols-outlined">description</span>
                  <span *ngSwitchDefault class="material-symbols-outlined">attach_file</span>
                </ng-container>
              </span>
              {{ selectedLeave?.documentName }}
            </ng-container>
            <ng-template #noDoc>
              <span class="no-document">No document submitted</span>
            </ng-template>
          </td>
        </tr>
      </table>
      <!-- File preview section -->
      <div *ngIf="selectedLeave?.documentName; else noPreview" class="file-preview improved-file-preview" style="margin-bottom:1.2rem;">
        <ng-container [ngSwitch]="getFileType(selectedLeave?.documentName)">
          <!-- Image preview -->
          <img *ngSwitchCase="'image'" [src]="getFileUrl(selectedLeave?.documentName)" alt="Image Preview" class="file-preview-img" />
          <!-- PDF preview -->
          <iframe *ngSwitchCase="'pdf'" [src]="getFileUrl(selectedLeave?.documentName)" class="file-preview-pdf" title="PDF Preview"></iframe>
          <!-- Doc/Other preview -->
          <div *ngSwitchDefault class="file-preview-link">
            <a [href]="getFileUrl(selectedLeave?.documentName)" target="_blank" rel="noopener" class="file-link">View/Download File</a>
          </div>
        </ng-container>
      </div>
      <ng-template #noPreview>
        <div class="no-preview-message">
          <span class="material-symbols-outlined no-doc-icon">draft</span>
          <span>No supporting document was submitted for this leave application.</span>
        </div>
      </ng-template>
      <div class="form-actions">
        <button type="button" (click)="showViewModal = false">Close</button>
      </div>
    </div>
  </div>
</div>
